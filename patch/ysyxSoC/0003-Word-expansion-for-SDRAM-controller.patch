From 88c77082ac25abf07a89d452fa7e863bc762ebad Mon Sep 17 00:00:00 2001
From: CmdBlock <CmdBlockZQG@outlook.com>
Date: Tue, 23 Apr 2024 02:18:31 +0800
Subject: [PATCH 03/13] Word expansion for SDRAM controller

---
 perip/sdram/core_sdram_axi4/sdram_axi.v      |  2 +-
 perip/sdram/core_sdram_axi4/sdram_axi_core.v | 12 ++---
 perip/sdram/sdram.v                          | 50 +++++++++++++++++++-
 perip/sdram/sdram_top_apb.v                  |  4 +-
 perip/sdram/sdram_top_axi.v                  |  4 +-
 src/device/SDRAM.scala                       |  2 +-
 6 files changed, 61 insertions(+), 13 deletions(-)

diff --git a/perip/sdram/core_sdram_axi4/sdram_axi.v b/perip/sdram/core_sdram_axi4/sdram_axi.v
index e743eb164..ba6246cbd 100644
--- a/perip/sdram/core_sdram_axi4/sdram_axi.v
+++ b/perip/sdram/core_sdram_axi4/sdram_axi.v
@@ -75,7 +75,7 @@ module sdram_axi
     ,output          sdram_we_o
     ,output [  3:0]  sdram_dqm_o
     ,output [ 12:0]  sdram_addr_o
-    ,output [  1:0]  sdram_ba_o
+    ,output [  2:0]  sdram_ba_o
     ,output [ 31:0]  sdram_data_output_o
     ,output          sdram_data_out_en_o
 );
diff --git a/perip/sdram/core_sdram_axi4/sdram_axi_core.v b/perip/sdram/core_sdram_axi4/sdram_axi_core.v
index 920b3fc44..8bb759e0a 100644
--- a/perip/sdram/core_sdram_axi4/sdram_axi_core.v
+++ b/perip/sdram/core_sdram_axi4/sdram_axi_core.v
@@ -57,7 +57,7 @@ module sdram_axi_core
     ,output          sdram_we_o
     ,output [  3:0]  sdram_dqm_o
     ,output [ 12:0]  sdram_addr_o
-    ,output [  1:0]  sdram_ba_o
+    ,output [  2:0]  sdram_ba_o
     ,output [ 31:0]  sdram_data_output_o
     ,output          sdram_data_out_en_o
 );
@@ -68,14 +68,14 @@ module sdram_axi_core
 // Key Params
 //-----------------------------------------------------------------
 parameter SDRAM_MHZ              = 50;
-parameter SDRAM_ADDR_W           = 24;
+parameter SDRAM_ADDR_W           = 25;
 parameter SDRAM_COL_W            = 9;
 parameter SDRAM_READ_LATENCY     = 2;
 
 //-----------------------------------------------------------------
 // Defines / Local params
 //-----------------------------------------------------------------
-localparam SDRAM_BANK_W          = 2;
+localparam SDRAM_BANK_W          = 3;
 localparam SDRAM_DQM_W           = 4;
 localparam SDRAM_BANKS           = 2 ** SDRAM_BANK_W;
 localparam SDRAM_ROW_W           = SDRAM_ADDR_W - SDRAM_COL_W - SDRAM_BANK_W;
@@ -172,9 +172,9 @@ reg  [STATE_W-1:0]     target_state_q;
 reg  [STATE_W-1:0]     delay_state_q;
 
 // Address bits
-wire [SDRAM_ROW_W-1:0]  addr_col_w  = {{(SDRAM_ROW_W-SDRAM_COL_W+1){1'b0}}, ram_addr_w[SDRAM_COL_W:2]};
-wire [SDRAM_ROW_W-1:0]  addr_row_w  = ram_addr_w[SDRAM_ADDR_W:SDRAM_COL_W+2+1];
-wire [SDRAM_BANK_W-1:0] addr_bank_w = ram_addr_w[SDRAM_COL_W+2:SDRAM_COL_W+2-1];
+wire [SDRAM_ROW_W-1:0]  addr_col_w  = {{(SDRAM_ROW_W-SDRAM_COL_W){1'b0}}, ram_addr_w[SDRAM_COL_W+2-1:2]};
+wire [SDRAM_ROW_W-1:0]  addr_row_w  = ram_addr_w[SDRAM_ADDR_W+2-1:SDRAM_BANK_W+SDRAM_COL_W+2];
+wire [SDRAM_BANK_W-1:0] addr_bank_w = ram_addr_w[SDRAM_COL_W+2+SDRAM_BANK_W-1:SDRAM_COL_W+2];
 
 //-----------------------------------------------------------------
 // SDRAM State Machine
diff --git a/perip/sdram/sdram.v b/perip/sdram/sdram.v
index 637fd090d..106239b1e 100644
--- a/perip/sdram/sdram.v
+++ b/perip/sdram/sdram.v
@@ -1,4 +1,52 @@
-module sdram(
+module sdram (
+  input        clk,
+  input        cke,
+  input        cs,
+  input        ras,
+  input        cas,
+  input        we,
+  input [12:0] a,
+  input [ 2:0] ba,
+  input [ 3:0] dqm,
+  inout [31:0] dq
+);
+
+  wire [2:0] cmd_in = {ras, cas, we};
+  wire nop = cs | (ras & cas & we);
+  wire sel = ba[2];
+  reg [2:0] cmd [2];
+
+  always_comb begin
+    cmd[0] = 3'b111;
+    cmd[1] = 3'b111;
+    if (~nop) case (cmd_in)
+      // ACTIVE READ WRITE
+      3'b011, 3'b101, 3'b100: begin
+        cmd[sel] = cmd_in;
+      end
+      // LOAD MODE REGISTER; BURST TERMINATE
+      3'b000, 3'b110: begin
+        cmd[0] = cmd_in;
+        cmd[1] = cmd_in;
+      end
+      default: begin end // NOP
+    endcase
+  end
+
+  sdram_32 sram0 (
+    .clk(clk), .cke(cke),
+    .cs(1'b0), .ras(cmd[0][2]), .cas(cmd[0][1]), .we(cmd[0][0]),
+    .a(a), .ba(ba[1:0]), .dqm(dqm), .dq(dq)
+  );
+
+  sdram_32 sram1 (
+    .clk(clk), .cke(cke),
+    .cs(1'b0), .ras(cmd[1][2]), .cas(cmd[1][1]), .we(cmd[1][0]),
+    .a(a), .ba(ba[1:0]), .dqm(dqm), .dq(dq)
+  );
+endmodule
+
+module sdram_32 (
   input        clk,
   input        cke,
   input        cs,
diff --git a/perip/sdram/sdram_top_apb.v b/perip/sdram/sdram_top_apb.v
index f127d7143..add8dcdb4 100644
--- a/perip/sdram/sdram_top_apb.v
+++ b/perip/sdram/sdram_top_apb.v
@@ -19,7 +19,7 @@ module sdram_top_apb (
   output        sdram_cas,
   output        sdram_we,
   output [12:0] sdram_a,
-  output [ 1:0] sdram_ba,
+  output [ 2:0] sdram_ba,
   output [ 3:0] sdram_dqm,
   inout  [31:0] sdram_dq
 );
@@ -47,7 +47,7 @@ module sdram_top_apb (
   wire is_write = ((in_psel && !in_penable) || (state == ST_WAIT_ACCEPT)) &&  in_pwrite;
   sdram_axi_core #(
     .SDRAM_MHZ(100),
-    .SDRAM_ADDR_W(24),
+    .SDRAM_ADDR_W(25),
     .SDRAM_COL_W(9),
     .SDRAM_READ_LATENCY(2)
   ) u_sdram_ctrl(
diff --git a/perip/sdram/sdram_top_axi.v b/perip/sdram/sdram_top_axi.v
index 5731f0def..fe3acd267 100644
--- a/perip/sdram/sdram_top_axi.v
+++ b/perip/sdram/sdram_top_axi.v
@@ -38,7 +38,7 @@ module sdram_top_axi(
   output        sdram_cas,
   output        sdram_we,
   output [12:0] sdram_a,
-  output [ 1:0] sdram_ba,
+  output [ 2:0] sdram_ba,
   output [ 3:0] sdram_dqm,
   inout  [31:0] sdram_dq
 );
@@ -48,7 +48,7 @@ module sdram_top_axi(
   assign sdram_dq = sdram_dout_en ? sdram_dout : 32'bz;
   sdram_axi #(
     .SDRAM_MHZ(100),
-    .SDRAM_ADDR_W(24),
+    .SDRAM_ADDR_W(25),
     .SDRAM_COL_W(9),
     .SDRAM_READ_LATENCY(2)
   ) u_sdram_axi(
diff --git a/src/device/SDRAM.scala b/src/device/SDRAM.scala
index ee948ef57..b2cb9b813 100644
--- a/src/device/SDRAM.scala
+++ b/src/device/SDRAM.scala
@@ -18,7 +18,7 @@ class SDRAMIO extends Bundle {
   val cas = Output(Bool())
   val we  = Output(Bool())
   val a   = Output(UInt(13.W))
-  val ba  = Output(UInt(2.W))
+  val ba  = Output(UInt(3.W))
   val dqm = Output(UInt(4.W))
   val dq  = Analog(32.W)
 }
-- 
2.50.1

