From 572c4e780650396e402dc9c58704bd734fbfe7f7 Mon Sep 17 00:00:00 2001
From: CmdBlock <54425466+CmdBlockZQG@users.noreply.github.com>
Date: Wed, 17 Jul 2024 17:08:42 +0800
Subject: [PATCH 10/13] disable delay module

---
 perip/amba/apb_delayer.v    | 21 ++++++++++++++++++-
 perip/amba/axi4_delayer.v   | 40 ++++++++++++++++++++++++++++++++++++-
 perip/spi/rtl/spi_top_apb.v |  2 +-
 3 files changed, 60 insertions(+), 3 deletions(-)

diff --git a/perip/amba/apb_delayer.v b/perip/amba/apb_delayer.v
index 03a113a0c..090046484 100644
--- a/perip/amba/apb_delayer.v
+++ b/perip/amba/apb_delayer.v
@@ -24,6 +24,10 @@ module apb_delayer(
   input         out_pslverr
 );
 
+// `define APB_DELAY_EN
+
+`ifdef APB_DELAY_EN
+
   typedef enum { st_idle, st_access, st_delay } state_t;
   state_t state;
 
@@ -38,7 +42,7 @@ module apb_delayer(
   assign out_penable = in_penable & out_psel;
 
   reg [31:0] cnt;
-  parameter RATIO = 32'd43;
+  parameter RATIO = 32'd36;
   parameter SCALER = 32'd10;
 
   always @(posedge clock) if (reset) begin
@@ -76,4 +80,19 @@ module apb_delayer(
     default: begin end
   endcase
 
+`else
+
+  assign out_paddr   = in_paddr;
+  assign out_psel    = in_psel;
+  assign out_penable = in_penable;
+  assign out_pprot   = in_pprot;
+  assign out_pwrite  = in_pwrite;
+  assign out_pwdata  = in_pwdata;
+  assign out_pstrb   = in_pstrb;
+  assign in_pready   = out_pready;
+  assign in_prdata   = out_prdata;
+  assign in_pslverr  = out_pslverr;
+
+`endif
+
 endmodule
diff --git a/perip/amba/axi4_delayer.v b/perip/amba/axi4_delayer.v
index bc378aa51..ff64c1e27 100644
--- a/perip/amba/axi4_delayer.v
+++ b/perip/amba/axi4_delayer.v
@@ -63,6 +63,10 @@ module axi4_delayer(
   input  [1:0]  out_bresp
 );
 
+// `define AXI_DELAY_EN
+
+`ifdef AXI_DELAY_EN
+
   // 状态定义
   typedef enum {
     st_idle,   // 空闲，无请求
@@ -72,7 +76,7 @@ module axi4_delayer(
   } state_t;
 
   // 参数
-  parameter RATIO = 32'd43;
+  parameter RATIO = 32'd36;
   parameter SCALER = 32'd10;
 
   // -------------------- 读延迟 --------------------
@@ -225,4 +229,38 @@ module axi4_delayer(
   assign in_bid = out_bid;
   assign in_bresp = out_bresp;
 
+`else
+
+  assign in_arready = out_arready;
+  assign out_arvalid = in_arvalid;
+  assign out_arid = in_arid;
+  assign out_araddr = in_araddr;
+  assign out_arlen = in_arlen;
+  assign out_arsize = in_arsize;
+  assign out_arburst = in_arburst;
+  assign out_rready = in_rready;
+  assign in_rvalid = out_rvalid;
+  assign in_rid = out_rid;
+  assign in_rdata = out_rdata;
+  assign in_rresp = out_rresp;
+  assign in_rlast = out_rlast;
+  assign in_awready = out_awready;
+  assign out_awvalid = in_awvalid;
+  assign out_awid = in_awid;
+  assign out_awaddr = in_awaddr;
+  assign out_awlen = in_awlen;
+  assign out_awsize = in_awsize;
+  assign out_awburst = in_awburst;
+  assign in_wready = out_wready;
+  assign out_wvalid = in_wvalid;
+  assign out_wdata = in_wdata;
+  assign out_wstrb = in_wstrb;
+  assign out_wlast = in_wlast;
+  assign out_bready = in_bready;
+  assign in_bvalid = out_bvalid;
+  assign in_bid = out_bid;
+  assign in_bresp = out_bresp;
+
+`endif
+
 endmodule
diff --git a/perip/spi/rtl/spi_top_apb.v b/perip/spi/rtl/spi_top_apb.v
index 496596648..e3544a09d 100644
--- a/perip/spi/rtl/spi_top_apb.v
+++ b/perip/spi/rtl/spi_top_apb.v
@@ -106,7 +106,7 @@ always @(posedge clock) begin if (~reset & flash_xip) begin
   if (st_apb == apb_idle) begin
     if (in_psel) begin
       if (in_pwrite) begin // 不支持写操作！
-        $fwrite(32'h80000002, "Assertion failed: XIP mode does not sopport write operation!\n");
+        $fwrite(32'h80000002, "Assertion failed: XIP mode does not support write operation!\n");
         $fatal;
       end
       st_apb <= apb_setup;
-- 
2.50.1

